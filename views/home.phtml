<?php
// Asegurar sesión activa
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Asegurar que la variable de sesión 'user' existe
if (!isset($_SESSION['user'])) {
    $_SESSION['user'] = false;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/styles/style.css">
    <title>Home Shop</title>
</head>
<body>

<?php
// Mostrar enlaces según el estado del usuario
if (!$_SESSION['user']) {
    echo "<a href='index.php?c=login'>Login</a>   ";
    echo "<a href='index.php?c=register'>Register</a>   ";
} else {
    echo "<a href='index.php?c=profile'>Profile</a>   ";
    echo "<a href='index.php?c=cart'>Shopping Cart</a>   ";
    echo "<a href='index.php?c=login&logout=1'>Logout</a>   ";
    echo "<a href='index.php?c=orders'>My Orders</a>   ";
}

// Mensaje de bienvenida o no autenticado
if ($_SESSION['user']) {
    echo "<p>Welcome, " . htmlspecialchars($_SESSION['user']->getUsername()) . "!</p>";
} else {
    echo "<p>You are not logged in.</p>";
}
?>

<h1>Shop Page</h1>
<p class="welcome-text">Welcome to the shop!</p>

<div id="product-list">
    <ul>
        <?php foreach ($products as $product): ?>
            <li>
                <img src="<?= htmlspecialchars($product->getImage()); ?>" alt="<?= htmlspecialchars($product->getName()); ?>">
                <h2>
                    <a href="index.php?c=product&id=<?= $product->getId(); ?>">
                        <?= htmlspecialchars($product->getName()); ?>
                    </a>
                </h2>
                <p>Price: <?= number_format($product->getPrice(), 2); ?> €</p>
                <p><?= htmlspecialchars($product->getDescription()); ?></p>

                <?php if ($_SESSION['user']): ?>
                    <form action="index.php?c=cart&addCart&product_id=<?= $product->getId(); ?>" method="post">
                        <input type="submit" value="Add to Cart">
                    </form>
                <?php else: ?>
                    <p style='color: red;'>Please log in to add products to your cart.</p>
                <?php endif; ?>
            </li>
        <?php endforeach; ?>
    </ul>
</div>

<?php
if (isset($_SESSION['message']) && isset($_SESSION['message_type'])) {
    $msg = $_SESSION['message'];
    $type = $_SESSION['message_type'];
    echo "
    <script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            Swal.fire({
                icon: '".($type == 'success' ? 'success' : 'error')."',
                title: '".($type == 'success' ? '¡Éxito!' : 'Error')."',
                text: '$msg'
            });
        });
    </script>";
    unset($_SESSION['message']);
    unset($_SESSION['message_type']);
}
?>

</body>
</html>
